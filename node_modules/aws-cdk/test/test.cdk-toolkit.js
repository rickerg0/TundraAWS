"use strict";
const nodeunit = require("nodeunit");
const stacks_1 = require("../lib/api/cxapp/stacks");
const sdk_1 = require("../lib/api/util/sdk");
const cdk_toolkit_1 = require("../lib/cdk-toolkit");
class MockStack {
    constructor(name, originalName = name, template = { Resources: { TempalteName: name } }, templateFile = `fake/stack/${name}.json`, assets = [], parameters = {}, environment = { name: 'MockEnv', account: '123456789012', region: 'bermuda-triangle-1' }) {
        this.name = name;
        this.originalName = originalName;
        this.template = template;
        this.templateFile = templateFile;
        this.assets = assets;
        this.parameters = parameters;
        this.environment = environment;
    }
}
class TestAppStacks extends stacks_1.AppStacks {
    constructor(test) {
        super(undefined);
        this.test = test;
    }
    getTagsFromStackMetadata(stack) {
        switch (stack.name) {
            case TestAppStacks.MOCK_STACK_A.name:
                return [{ Key: 'Foo', Value: 'Bar' }];
            case TestAppStacks.MOCK_STACK_B.name:
                return [{ Key: 'Baz', Value: 'Zinga!' }];
            default:
                throw new Error(`Not an expected mock stack: ${stack.name}`);
        }
    }
    selectStacks(selectors) {
        this.test.deepEqual(selectors, ['Test-Stack-A', 'Test-Stack-B']);
        return Promise.resolve([
            // Cheating the type system here (intentionally, so we have to stub less!)
            TestAppStacks.MOCK_STACK_A,
            TestAppStacks.MOCK_STACK_B,
        ]);
    }
    processMetadata(stacks) {
        stacks.forEach(stack => this.test.ok(stack === TestAppStacks.MOCK_STACK_A || stack === TestAppStacks.MOCK_STACK_B, `Not an expected mock stack: ${stack.name}`));
    }
    listStacks() {
        throw new Error('Not Implemented');
    }
    synthesizeStack() {
        throw new Error('Not Implemented');
    }
    synthesizeStacks() {
        throw new Error('Not Implemented');
    }
}
TestAppStacks.MOCK_STACK_A = new MockStack('Test-Stack-A');
TestAppStacks.MOCK_STACK_B = new MockStack('Test-Stack-B');
class TestProvisioner {
    constructor(test, expectedTags = {}, expectedNotificationArns) {
        this.test = test;
        this.expectedTags = {};
        for (const [stackName, tags] of Object.entries(expectedTags)) {
            this.expectedTags[stackName] =
                Object.entries(tags).map(([Key, Value]) => ({ Key, Value }))
                    .sort((l, r) => l.Key.localeCompare(r.Key));
        }
        if (expectedNotificationArns) {
            this.expectedNotificationArns = expectedNotificationArns;
        }
    }
    deployStack(options) {
        this.test.ok(options.stack.name === TestAppStacks.MOCK_STACK_A.name || options.stack.name === TestAppStacks.MOCK_STACK_B.name, `Not an expected mock stack: ${options.stack.name}`);
        this.test.deepEqual(options.tags, this.expectedTags[options.stack.name]);
        this.test.deepEqual(options.notificationArns, this.expectedNotificationArns);
        return Promise.resolve({
            stackArn: `arn:aws:cloudformation:::stack/${options.stack.name}/MockedOut`,
            noOp: false,
            outputs: { StackName: options.stack.name },
        });
    }
    readCurrentTemplate(stack) {
        switch (stack.name) {
            case TestAppStacks.MOCK_STACK_A.name:
                return Promise.resolve({});
            case TestAppStacks.MOCK_STACK_B.name:
                return Promise.resolve({});
            default:
                return Promise.reject(`Not an expected mock stack: ${stack.name}`);
        }
    }
}
module.exports = nodeunit.testCase({
    deploy: {
        'makes correct CloudFormation calls': {
            'without options'(test) {
                // GIVEN
                const toolkit = new cdk_toolkit_1.CdkToolkit({
                    appStacks: new TestAppStacks(test),
                    provisioner: new TestProvisioner(test, {
                        'Test-Stack-A': { Foo: 'Bar' },
                        'Test-Stack-B': { Baz: 'Zinga!' },
                    }),
                });
                // WHEN
                toolkit.deploy({ stackNames: ['Test-Stack-A', 'Test-Stack-B'], sdk: new sdk_1.SDK() });
                // THEN
                test.done();
            },
            'with sns notification arns'(test) {
                // GIVEN
                const notificationArns = ['arn:aws:sns:::cfn-notifications', 'arn:aws:sns:::my-cool-topic'];
                const toolkit = new cdk_toolkit_1.CdkToolkit({
                    appStacks: new TestAppStacks(test),
                    provisioner: new TestProvisioner(test, {
                        'Test-Stack-A': { Foo: 'Bar' },
                        'Test-Stack-B': { Baz: 'Zinga!' },
                    }, notificationArns),
                });
                // WHEN
                toolkit.deploy({
                    stackNames: ['Test-Stack-A', 'Test-Stack-B'],
                    notificationArns,
                    sdk: new sdk_1.SDK()
                });
                // THEN
                test.done();
            },
        },
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC5jZGstdG9vbGtpdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInRlc3QuY2RrLXRvb2xraXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLHFDQUFzQztBQUN0QyxvREFBeUQ7QUFHekQsNkNBQTBDO0FBQzFDLG9EQUFnRDtBQThDaEQsTUFBTSxTQUFTO0lBQ2IsWUFDa0IsSUFBWSxFQUNaLGVBQXVCLElBQUksRUFDM0IsV0FBZ0IsRUFBRSxTQUFTLEVBQUUsRUFBRSxZQUFZLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFDckQsZUFBdUIsY0FBYyxJQUFJLE9BQU8sRUFDaEQsU0FBcUMsRUFBRSxFQUN2QyxhQUF1QyxFQUFFLEVBQ3pDLGNBQWlDLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sRUFBRSxvQkFBb0IsRUFBRTtRQU4zRyxTQUFJLEdBQUosSUFBSSxDQUFRO1FBQ1osaUJBQVksR0FBWixZQUFZLENBQWU7UUFDM0IsYUFBUSxHQUFSLFFBQVEsQ0FBNkM7UUFDckQsaUJBQVksR0FBWixZQUFZLENBQW9DO1FBQ2hELFdBQU0sR0FBTixNQUFNLENBQWlDO1FBQ3ZDLGVBQVUsR0FBVixVQUFVLENBQStCO1FBQ3pDLGdCQUFXLEdBQVgsV0FBVyxDQUFnRztJQUMxSCxDQUFDO0NBQ0w7QUFFRCxNQUFNLGFBQWMsU0FBUSxrQkFBUztJQUluQyxZQUE2QixJQUFtQjtRQUM5QyxLQUFLLENBQUMsU0FBZ0IsQ0FBQyxDQUFDO1FBREcsU0FBSSxHQUFKLElBQUksQ0FBZTtJQUVoRCxDQUFDO0lBRU0sd0JBQXdCLENBQUMsS0FBd0M7UUFDdEUsUUFBUSxLQUFLLENBQUMsSUFBSSxFQUFFO1lBQ2xCLEtBQUssYUFBYSxDQUFDLFlBQVksQ0FBQyxJQUFJO2dCQUNsQyxPQUFPLENBQUMsRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1lBQ3hDLEtB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QUFRLEVBQUU7cUJBQ2xDLENBQUM7aUJBQ0gsQ0FBQyxDQUFDO2dCQUVILE9BQU87Z0JBQ1AsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFLFVBQVUsRUFBRSxDQUFDLGNBQWMsRUFBRSxjQUFjLENBQUMsRUFBRSxHQUFHLEVBQUUsSUFBSSxTQUFHLEVBQUUsRUFBRSxDQUFDLENBQUM7Z0JBRWpGLE9BQU87Z0JBQ1AsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ2QsQ0FBQztZQUNELDRCQUE0QixDQUFDLElBQW1CO2dCQUM5QyxRQUFRO2dCQUNSLE1BQU0sZ0JBQWdCLEdBQUcsQ0FBQyxpQ0FBaUMsRUFBRSw2QkFBNkIsQ0FBQyxDQUFDO2dCQUM1RixNQUFNLE9BQU8sR0FBRyxJQUFJLHdCQUFVLENBQUM7b0JBQzdCLFNBQVMsRUFBRSxJQUFJLGFBQWEsQ0FBQyxJQUFJLENBQUM7b0JBQ2xDLFdBQVcsRUFBRSxJQUFJLGVBQWUsQ0FBQyxJQUFJLEVBQUU7d0JBQ3JDLGNBQWMsRUFBRSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUU7d0JBQzlCLGNBQWMsRUFBRSxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUU7cUJBQ2xDLEVBQUUsZ0JBQWdCLENBQUM7aUJBQ3JCLENBQUMsQ0FBQztnQkFFSCxPQUFPO2dCQUNQLE9BQU8sQ0FBQyxNQUFNLENBQUM7b0JBQ2IsVUFBVSxFQUFFLENBQUMsY0FBYyxFQUFFLGNBQWMsQ0FBQztvQkFDNUMsZ0JBQWdCO29CQUNoQixHQUFHLEVBQUUsSUFBSSxTQUFHLEVBQUU7aUJBQ2YsQ0FBQyxDQUFDO2dCQUVILE9BQU87Z0JBQ1AsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ2QsQ0FBQztTQUNGO0tBQ0Y7Q0FDRixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY3hhcGkgPSByZXF1aXJlKCdAYXdzLWNkay9jeC1hcGknKTtcbmltcG9ydCBub2RldW5pdCA9IHJlcXVpcmUoJ25vZGV1bml0Jyk7XG5pbXBvcnQgeyBBcHBTdGFja3MsIFRhZyB9IGZyb20gJy4uL2xpYi9hcGkvY3hhcHAvc3RhY2tzJztcbmltcG9ydCB7IERlcGxveVN0YWNrUmVzdWx0IH0gZnJvbSAnLi4vbGliL2FwaS9kZXBsb3ktc3RhY2snO1xuaW1wb3J0IHsgRGVwbG95U3RhY2tPcHRpb25zLCBJRGVwbG95bWVudFRhcmdldCwgVGVtcGxhdGUgfSBmcm9tICcuLi9saWIvYXBpL2RlcGxveW1lbnQtdGFyZ2V0JztcbmltcG9ydCB7IFNESyB9IGZyb20gJy4uL2xpYi9hcGkvdXRpbC9zZGsnO1xuaW1wb3J0IHsgQ2RrVG9vbGtpdCB9IGZyb20gJy4uL2xpYi9jZGstdG9vbGtpdCc7XG5cbmV4cG9ydCA9IG5vZGV1bml0LnRlc3RDYXNlKHtcbiAgZGVwbG95OiB7XG4gICAgJ21ha2VzIGNvcnJlY3QgQ2xvdWRGb3JtYXRpb24gY2FsbHMnOiB7XG4gICAgICAnd2l0aG91dCBvcHRpb25zJyh0ZXN0OiBub2RldW5pdC5UZXN0KSB7XG4gICAgICAgIC8vIEdJVkVOXG4gICAgICAgIGNvbnN0IHRvb2xraXQgPSBuZXcgQ2RrVG9vbGtpdCh7XG4gICAgICAgICAgYXBwU3RhY2tzOiBuZXcgVGVzdEFwcFN0YWNrcyh0ZXN0KSxcbiAgICAgICAgICBwcm92aXNpb25lcjogbmV3IFRlc3RQcm92aXNpb25lcih0ZXN0LCB7XG4gICAgICAgICAgICAnVGVzdC1TdGFjay1BJzogeyBGb286ICdCYXInIH0sXG4gICAgICAgICAgICAnVGVzdC1TdGFjay1CJzogeyBCYXo6ICdaaW5nYSEnIH0sXG4gICAgICAgICAgfSksXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIFdIRU5cbiAgICAgICAgdG9vbGtpdC5kZXBsb3koeyBzdGFja05hbWVzOiBbJ1Rlc3QtU3RhY2stQScsICdUZXN0LVN0YWNrLUInXSwgc2RrOiBuZXcgU0RLKCkgfSk7XG5cbiAgICAgICAgLy8gVEhFTlxuICAgICAgICB0ZXN0LmRvbmUoKTtcbiAgICAgIH0sXG4gICAgICAnd2l0aCBzbnMgbm90aWZpY2F0aW9uIGFybnMnKHRlc3Q6IG5vZGV1bml0LlRlc3QpIHtcbiAgICAgICAgLy8gR0lWRU5cbiAgICAgICAgY29uc3Qgbm90aWZpY2F0aW9uQXJucyA9IFsnYXJuOmF3czpzbnM6OjpjZm4tbm90aWZpY2F0aW9ucycsICdhcm46YXdzOnNuczo6Om15LWNvb2wtdG9waWMnXTtcbiAgICAgICAgY29uc3QgdG9vbGtpdCA9IG5ldyBDZGtUb29sa2l0KHtcbiAgICAgICAgICBhcHBTdGFja3M6IG5ldyBUZXN0QXBwU3RhY2tzKHRlc3QpLFxuICAgICAgICAgIHByb3Zpc2lvbmVyOiBuZXcgVGVzdFByb3Zpc2lvbmVyKHRlc3QsIHtcbiAgICAgICAgICAgICdUZXN0LVN0YWNrLUEnOiB7IEZvbzogJ0JhcicgfSxcbiAgICAgICAgICAgICdUZXN0LVN0YWNrLUInOiB7IEJhejogJ1ppbmdhIScgfSxcbiAgICAgICAgICB9LCBub3RpZmljYXRpb25Bcm5zKSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gV0hFTlxuICAgICAgICB0b29sa2l0LmRlcGxveSh7XG4gICAgICAgICAgc3RhY2tOYW1lczogWydUZXN0LVN0YWNrLUEnLCAnVGVzdC1TdGFjay1CJ10sXG4gICAgICAgICAgbm90aWZpY2F0aW9uQXJucyxcbiAgICAgICAgICBzZGs6IG5ldyBTREsoKVxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBUSEVOXG4gICAgICAgIHRlc3QuZG9uZSgpO1xuICAgICAgfSxcbiAgICB9LFxuICB9LFxufSk7XG5cbmNsYXNzIE1vY2tTdGFjayB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyByZWFkb25seSBuYW1lOiBzdHJpbmcsXG4gICAgcHVibGljIHJlYWRvbmx5IG9yaWdpbmFsTmFtZTogc3RyaW5nID0gbmFtZSxcbiAgICBwdWJsaWMgcmVhZG9ubHkgdGVtcGxhdGU6IGFueSA9IHsgUmVzb3VyY2VzOiB7IFRlbXBhbHRlTmFtZTogbmFtZSB9IH0sXG4gICAgcHVibGljIHJlYWRvbmx5IHRlbXBsYXRlRmlsZTogc3RyaW5nID0gYGZha2Uvc3RhY2svJHtuYW1lfS5qc29uYCxcbiAgICBwdWJsaWMgcmVhZG9ubHkgYXNzZXRzOiBjeGFwaS5Bc3NldE1ldGFkYXRhRW50cnlbXSA9IFtdLFxuICAgIHB1YmxpYyByZWFkb25seSBwYXJhbWV0ZXJzOiB7IFtpZDogc3RyaW5nXTogc3RyaW5nIH0gPSB7fSxcbiAgICBwdWJsaWMgcmVhZG9ubHkgZW52aXJvbm1lbnQ6IGN4YXBpLkVudmlyb25tZW50ID0geyBuYW1lOiAnTW9ja0VudicsIGFjY291bnQ6ICcxMjM0NTY3ODkwMTInLCByZWdpb246ICdiZXJtdWRhLXRyaWFuZ2xlLTEnIH0sXG4gICkge31cbn1cblxuY2xhc3MgVGVzdEFwcFN0YWNrcyBleHRlbmRzIEFwcFN0YWNrcyB7XG4gIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgTU9DS19TVEFDS19BID0gbmV3IE1vY2tTdGFjaygnVGVzdC1TdGFjay1BJyk7XG4gIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgTU9DS19TVEFDS19CID0gbmV3IE1vY2tTdGFjaygnVGVzdC1TdGFjay1CJyk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSB0ZXN0OiBub2RldW5pdC5UZXN0KSB7XG4gICAgc3VwZXIodW5kZWZpbmVkIGFzIGFueSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0VGFnc0Zyb21TdGFja01ldGFkYXRhKHN0YWNrOiBjeGFwaS5DbG91ZEZvcm1hdGlvblN0YWNrQXJ0aWZhY3QpOiBUYWdbXSB7XG4gICAgc3dpdGNoIChzdGFjay5uYW1lKSB7XG4gICAgICBjYXNlIFRlc3RBcHBTdGFja3MuTU9DS19TVEFDS19BLm5hbWU6XG4gICAgICAgIHJldHVybiBbeyBLZXk6ICdGb28nLCBWYWx1ZTogJ0JhcicgfV07XG4gICAgICBjYXNlIFRlc3RBcHBTdGFja3MuTU9DS19TVEFDS19CLm5hbWU6XG4gICAgICAgIHJldHVybiBbeyBLZXk6ICdCYXonLCBWYWx1ZTogJ1ppbmdhIScgfV07XG4gICAgICBkZWZhdWx0OlxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vdCBhbiBleHBlY3RlZCBtb2NrIHN0YWNrOiAke3N0YWNrLm5hbWV9YCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHNlbGVjdFN0YWNrcyhzZWxlY3RvcnM6IHN0cmluZ1tdKTogUHJvbWlzZTxjeGFwaS5DbG91ZEZvcm1hdGlvblN0YWNrQXJ0aWZhY3RbXT4ge1xuICAgIHRoaXMudGVzdC5kZWVwRXF1YWwoc2VsZWN0b3JzLCBbJ1Rlc3QtU3RhY2stQScsICdUZXN0LVN0YWNrLUInXSk7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShbXG4gICAgICAvLyBDaGVhdGluZyB0aGUgdHlwZSBzeXN0ZW0gaGVyZSAoaW50ZW50aW9uYWxseSwgc28gd2UgaGF2ZSB0byBzdHViIGxlc3MhKVxuICAgICAgVGVzdEFwcFN0YWNrcy5NT0NLX1NUQUNLX0EgYXMgY3hhcGkuQ2xvdWRGb3JtYXRpb25TdGFja0FydGlmYWN0LFxuICAgICAgVGVzdEFwcFN0YWNrcy5NT0NLX1NUQUNLX0IgYXMgY3hhcGkuQ2xvdWRGb3JtYXRpb25TdGFja0FydGlmYWN0LFxuICAgIF0pO1xuICB9XG5cbiAgcHVibGljIHByb2Nlc3NNZXRhZGF0YShzdGFja3M6IGN4YXBpLkNsb3VkRm9ybWF0aW9uU3RhY2tBcnRpZmFjdFtdKTogdm9pZCB7XG4gICAgc3RhY2tzLmZvckVhY2goc3RhY2sgPT5cbiAgICAgIHRoaXMudGVzdC5vayhzdGFjayA9PT0gVGVzdEFwcFN0YWNrcy5NT0NLX1NUQUNLX0EgfHwgc3RhY2sgPT09IFRlc3RBcHBTdGFja3MuTU9DS19TVEFDS19CLFxuICAgICAgICBgTm90IGFuIGV4cGVjdGVkIG1vY2sgc3RhY2s6ICR7c3RhY2submFtZX1gKSk7XG4gIH1cblxuICBwdWJsaWMgbGlzdFN0YWNrcygpOiBuZXZlciB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdOb3QgSW1wbGVtZW50ZWQnKTtcbiAgfVxuXG4gIHB1YmxpYyBzeW50aGVzaXplU3RhY2soKTogbmV2ZXIge1xuICAgIHRocm93IG5ldyBFcnJvcignTm90IEltcGxlbWVudGVkJyk7XG4gIH1cblxuICBwdWJsaWMgc3ludGhlc2l6ZVN0YWNrcygpOiBuZXZlciB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdOb3QgSW1wbGVtZW50ZWQnKTtcbiAgfVxufVxuXG5jbGFzcyBUZXN0UHJvdmlzaW9uZXIgaW1wbGVtZW50cyBJRGVwbG95bWVudFRhcmdldCB7XG4gIHByaXZhdGUgcmVhZG9ubHkgZXhwZWN0ZWRUYWdzOiB7IFtzdGFja05hbWU6IHN0cmluZ106IFRhZ1tdIH0gPSB7fTtcbiAgcHJpdmF0ZSByZWFkb25seSBleHBlY3RlZE5vdGlmaWNhdGlvbkFybnM6IHN0cmluZ1tdO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgdGVzdDogbm9kZXVuaXQuVGVzdCxcbiAgICBleHBlY3RlZFRhZ3M6IHsgW3N0YWNrTmFtZTogc3RyaW5nXTogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfSB9ID0ge30sXG4gICAgZXhwZWN0ZWROb3RpZmljYXRpb25Bcm5zPzogc3RyaW5nW10sXG4gICkge1xuICAgIGZvciAoY29uc3QgW3N0YWNrTmFtZSwgdGFnc10gb2YgT2JqZWN0LmVudHJpZXMoZXhwZWN0ZWRUYWdzKSkge1xuICAgICAgdGhpcy5leHBlY3RlZFRhZ3Nbc3RhY2tOYW1lXSA9XG4gICAgICAgIE9iamVjdC5lbnRyaWVzKHRhZ3MpLm1hcCgoW0tleSwgVmFsdWVdKSA9PiAoeyBLZXksIFZhbHVlIH0pKVxuICAgICAgICAgIC5zb3J0KChsLCByKSA9PiAgbC5LZXkubG9jYWxlQ29tcGFyZShyLktleSkpO1xuICAgIH1cbiAgICBpZiAoZXhwZWN0ZWROb3RpZmljYXRpb25Bcm5zKSB7XG4gICAgICB0aGlzLmV4cGVjdGVkTm90aWZpY2F0aW9uQXJucyA9IGV4cGVjdGVkTm90aWZpY2F0aW9uQXJucztcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZGVwbG95U3RhY2sob3B0aW9uczogRGVwbG95U3RhY2tPcHRpb25zKTogUHJvbWlzZTxEZXBsb3lTdGFja1Jlc3VsdD4ge1xuICAgIHRoaXMudGVzdC5vayhcbiAgICAgIG9wdGlvbnMuc3RhY2submFtZSA9PT0gVGVzdEFwcFN0YWNrcy5NT0NLX1NUQUNLX0EubmFtZSB8fCBvcHRpb25zLnN0YWNrLm5hbWUgPT09IFRlc3RBcHBTdGFja3MuTU9DS19TVEFDS19CLm5hbWUsXG4gICAgICBgTm90IGFuIGV4cGVjdGVkIG1vY2sgc3RhY2s6ICR7b3B0aW9ucy5zdGFjay5uYW1lfWBcbiAgICApO1xuICAgIHRoaXMudGVzdC5kZWVwRXF1YWwob3B0aW9ucy50YWdzLCB0aGlzLmV4cGVjdGVkVGFnc1tvcHRpb25zLnN0YWNrLm5hbWVdKTtcbiAgICB0aGlzLnRlc3QuZGVlcEVxdWFsKG9wdGlvbnMubm90aWZpY2F0aW9uQXJucywgdGhpcy5leHBlY3RlZE5vdGlmaWNhdGlvbkFybnMpO1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe1xuICAgICAgc3RhY2tBcm46IGBhcm46YXdzOmNsb3VkZm9ybWF0aW9uOjo6c3RhY2svJHtvcHRpb25zLnN0YWNrLm5hbWV9L01vY2tlZE91dGAsXG4gICAgICBub09wOiBmYWxzZSxcbiAgICAgIG91dHB1dHM6IHsgU3RhY2tOYW1lOiBvcHRpb25zLnN0YWNrLm5hbWUgfSxcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyByZWFkQ3VycmVudFRlbXBsYXRlKHN0YWNrOiBjeGFwaS5DbG91ZEZvcm1hdGlvblN0YWNrQXJ0aWZhY3QpOiBQcm9taXNlPFRlbXBsYXRlPiB7XG4gICAgc3dpdGNoIChzdGFjay5uYW1lKSB7XG4gICAgICBjYXNlIFRlc3RBcHBTdGFja3MuTU9DS19TVEFDS19BLm5hbWU6XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe30pO1xuICAgICAgY2FzZSBUZXN0QXBwU3RhY2tzLk1PQ0tfU1RBQ0tfQi5uYW1lOlxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHt9KTtcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChgTm90IGFuIGV4cGVjdGVkIG1vY2sgc3RhY2s6ICR7c3RhY2submFtZX1gKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==